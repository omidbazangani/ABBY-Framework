Code from https://cr.yp.to/snuffle.html